<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro de Clientes - ORION PDV</title>
  <link rel="stylesheet" href="assets/css/orion-theme.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
  <div class="wrapper">
    <!-- Sidebar (igual ao dashboard.html) -->
    <aside class="sidebar">
      <div class="logo">
        <img src="assets/img/logo.png" alt="ORION PDV">
        <span class="logo-text">ORION PDV</span>
      </div>
      
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="dashboard.html" class="nav-link">
            <i class="fas fa-tachometer-alt nav-icon"></i>
            <span>Dashboard</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="venda.html" class="nav-link">
            <i class="fas fa-shopping-cart nav-icon"></i>
            <span>Registrar Venda</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="produto.html" class="nav-link">
            <i class="fas fa-box nav-icon"></i>
            <span>Cadastrar Produto</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="cliente.html" class="nav-link active">
            <i class="fas fa-user nav-icon"></i>
            <span>Cadastrar Cliente</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="relatorio
            <!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro de Clientes - ORION PDV</title>
  <link rel="stylesheet" href="assets/css/orion-theme.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
  <div class="wrapper">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo">
        <img src="assets/img/logo.png" alt="ORION PDV">
        <span class="logo-text">ORION PDV</span>
      </div>
      
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="dashboard.html" class="nav-link">
            <i class="fas fa-tachometer-alt nav-icon"></i>
            <span>Dashboard</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="venda.html" class="nav-link">
            <i class="fas fa-shopping-cart nav-icon"></i>
            <span>Registrar Venda</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="produto.html" class="nav-link">
            <i class="fas fa-box nav-icon"></i>
            <span>Cadastrar Produto</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="cliente.html" class="nav-link active">
            <i class="fas fa-user nav-icon"></i>
            <span>Cadastrar Cliente</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="relatorio.html" class="nav-link">
            <i class="fas fa-chart-bar nav-icon"></i>
            <span>Painel Financeiro</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="estoque.html" class="nav-link">
            <i class="fas fa-warehouse nav-icon"></i>
            <span>Gerenciar Estoque</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="config.html" class="nav-link">
            <i class="fas fa-cog nav-icon"></i>
            <span>Configurações</span>
          </a>
        </li>
      </ul>
      
      <div style="margin-top: auto; padding: 1rem 1.5rem; border-top: 1px solid rgba(255,255,255,0.1);">
        <div style="display: flex; align-items: center; margin-bottom: 1rem;">
          <i class="fas fa-user-circle" style="font-size: 1.5rem; margin-right: 10px;"></i>
          <div>
            <div id="user-name" style="font-weight: 500;">Nome do Usuário</div>
            <small class="text-muted">Administrador</small>
          </div>
        </div>
        <button id="btn-logout" class="btn btn-outline-primary" style="width: 100%;">
          <i class="fas fa-sign-out-alt"></i> Sair
        </button>
      </div>
    </aside>

    <!-- Conteúdo principal -->
    <main class="content">
      <div class="header" style="margin-bottom: 1.5rem;">
        <h1>Cadastro de Clientes</h1>
        <div>
          <span id="current-date"></span>
        </div>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 400px; gap: 1.5rem;">
        <!-- Lista de clientes -->
        <div class="card">
          <div class="card-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <i class="fas fa-users"></i> Clientes Cadastrados
              </div>
              <div style="display: flex; gap: 0.5rem;">
                <div style="position: relative;">
                  <input type="text" id="busca-cliente" class="form-control" placeholder="Buscar cliente..." style="width: 250px; padding-left: 36px;">
                  <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted);"></i>
                </div>
                <button id="btn-novo-cliente" class="btn btn-primary">
                  <i class="fas fa-plus"></i> Novo
                </button>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="table-container">
              <table class="table" id="tabela-clientes">
                <thead>
                  <tr>
                    <th>Nome</th>
                    <th>Documento</th>
                    <th>Telefone</th>
                    <th>Cidade</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Preenchido via JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- Formulário de cliente -->
        <div class="card" id="card-formulario">
          <div class="card-header">
            <i class="fas fa-user"></i> <span id="form-titulo">Novo Cliente</span>
          </div>
          <div class="card-body">
            <form id="form-cliente">
              <input type="hidden" id="cliente-id">
              
              <div class="form-group">
                <label for="nome" class="form-label">Nome Completo</label>
                <input type="text" id="nome" class="form-control" required>
              </div>
              
              <div class="form-group">
                <label for="documento" class="form-label">CPF/CNPJ</label>
                <input type="text" id="documento" class="form-control">
              </div>
              
              <div class="form-group">
                <label for="telefone" class="form-label">Telefone</label>
                <input type="tel" id="telefone" class="form-control">
              </div>
              
              <div class="form-group">
                <label for="email" class="form-label">E-mail</label>
                <input type="email" id="email" class="form-control">
              </div>
              
              <div class="form-group">
                <label for="endereco" class="form-label">Endereço</label>
                <input type="text" id="endereco" class="form-control">
              </div>
              
              <div class="form-group">
                <label for="cidade" class="form-label">Cidade</label>
                <input type="text" id="cidade" class="form-control">
              </div>
              
              <div class="form-group">
                <label for="observacoes" class="form-label">Observações</label>
                <textarea id="observacoes" class="form-control" rows="3"></textarea>
              </div>
              
              <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                <button type="button" id="btn-cancelar" class="btn btn-outline-primary" style="flex: 1;">
                  Cancelar
                </button>
                <button type="submit" class="btn btn-primary" style="flex: 1;">
                  Salvar
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
      
      <!-- Modal de detalhes do cliente -->
      <div id="modal-detalhes" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div class="modal-content" style="background-color: var(--dark-surface); width: 600px; max-width: 90%; border-radius: var(--border-radius); box-shadow: var(--box-shadow);">
          <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3 id="detalhe-nome">Detalhes do Cliente</h3>
            <button type="button" class="btn-close-modal" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">&times;</button>
          </div>
          <div class="card-body">
            <div class="row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
              <div>
                <p class="text-muted">Documento</p>
                <p id="detalhe-documento">-</p>
              </div>
              <div>
                <p class="text-muted">Data de Cadastro</p>
                <p id="detalhe-data">-</p>
              </div>
              <div>
                <p class="text-muted">Telefone</p>
                <p id="detalhe-telefone">-</p>
              </div>
              <div>
                <p class="text-muted">E-mail</p>
                <p id="detalhe-email">-</p>
              </div>
              <div>
                <p class="text-muted">Endereço</p>
                <p id="detalhe-endereco">-</p>
              </div>
              <div>
                <p class="text-muted">Cidade</p>
                <p id="detalhe-cidade">-</p>
              </div>
            </div>
            
            <div style="margin-top: 1rem;">
              <p class="text-muted">Observações</p>
              <p id="detalhe-observacoes">-</p>
            </div>
            
            <div class="card" style="margin-top: 1.5rem;">
              <div class="card-header">
                <i class="fas fa-shopping-cart"></i> Últimas Compras
              </div>
              <div class="card-body">
                <div id="ultimas-compras">
                  <p class="text-center text-muted">Nenhuma compra encontrada</p>
                </div>
              </div>
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem;">
              <button type="button" class="btn-close-modal btn btn-outline-primary">
                Fechar
              </button>
              <button type="button" id="btn-editar-detalhe" class="btn btn-primary">
                <i class="fas fa-edit"></i> Editar
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="assets/js/database.js"></script>
  <script src="assets/js/auth.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Verificar autenticação
      if (!auth.verificarAutenticacao()) {
        window.location.href = 'index.html';
        return;
      }
      
      // Elementos DOM
      const buscaClienteInput = document.getElementById('busca-cliente');
      const tabelaClientes = document.getElementById('tabela-clientes');
      const formCliente = document.getElementById('form-cliente');
      const cardFormulario = document.getElementById('card-formulario');
      const formTitulo = document.getElementById('form-titulo');
      const clienteIdInput = document.getElementById('cliente-id');
      const nomeInput = document.getElementById('nome');
      const documentoInput = document.getElementById('documento');
      const telefoneInput = document.getElementById('telefone');
      const emailInput = document.getElementById('email');
      const enderecoInput = document.getElementById('endereco');
      const cidadeInput = document.getElementById('cidade');
      const observacoesInput = document.getElementById('observacoes');
      const btnNovoCliente = document.getElementById('btn-novo-cliente');
      const btnCancelar = document.getElementById('btn-cancelar');
      
      // Modal
      const modalDetalhes = document.getElementById('modal-detalhes');
      const btnFecharModal = document.querySelectorAll('.btn-close-modal');
      const btnEditarDetalhe = document.getElementById('btn-editar-detalhe');
      
      // Variáveis de controle
      let modoEdicao = false;
      let clienteAtual = null;
      
      // Dados do usuário
      const user = auth.getUsuarioAtual();
      document.getElementById('user-name').textContent = user.nome;
      
      // Data atual
      const dataAtual = new Date();
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('current-date').textContent = dataAtual.toLocaleDateString('pt-BR', options);
      
      // Carregar dados iniciais
      carregarClientes();
      
      // Event Listeners
      buscaClienteInput.addEventListener('input', carregarClientes);
      formCliente.addEventListener('submit', salvarCliente);
      btnNovoCliente.addEventListener('click', novoCliente);
      btnCancelar.addEventListener('click', cancelarFormulario);
      
      btnFecharModal.forEach(btn => {
        btn.addEventListener('click', function() {
          modalDetalhes.style.display = 'none';
        });
      });
      
      btnEditarDetalhe.addEventListener('click', function() {
        modalDetalhes.style.display = 'none';
        editarCliente(clienteAtual.id);
      });
      
      // Formatar CPF/CNPJ ao digitar
      documentoInput.addEventListener('input', function() {
        let valor = this.value.replace(/\D/g, '');
        
        if (valor.length <= 11) {
          // CPF
          valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
          valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
          valor = valor.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        } else {
          // CNPJ
          valor = valor.replace(/^(\d{2})(\d)/, '$1.$2');
          valor = valor.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
          valor = valor.replace(/\.(\d{3})(\d)/, '.$1/$2');
          valor = valor.replace(/(\d{4})(\d)/, '$1-$2');
        }
        
        this.value = valor;
      });
      
      // Formatar telefone ao digitar
      telefoneInput.addEventListener('input', function() {
        let valor = this.value.replace(/\D/g, '');
        
        if (valor.length <= 10) {
          // Telefone fixo
          valor = valor.replace(/(\d{2})(\d)/, '($1) $2');
          valor = valor.replace(/(\d{4})(\d)/, '$1-$2');
        } else {
          // Celular
          valor = valor.replace(/(\d{2})(\d)/, '($1) $2');
          valor = valor.replace(/(\d{5})(\d)/, '$1-$2');
        }
        
        this.value = valor;
      });
      
      // Logout
      document.getElementById('btn-logout').addEventListener('click', function() {
        auth.fazerLogout();
        window.location.href = 'index.html';
      });
      
      // Funções
      function carregarClientes() {
        const clientes = db.getClientes();
        const termoBusca = buscaClienteInput.value.toLowerCase();
        
        // Limpar tabela
        const tbody = tabelaClientes.querySelector('tbody');
        tbody.innerHTML = '';
        
        // Filtrar clientes
        let clientesFiltrados = [...clientes];
        
        if (termoBusca) {
          clientesFiltrados = clientesFiltrados.filter(cliente => 
            cliente.nome.toLowerCase().includes(termoBusca) || 
            (cliente.documento && cliente.documento.toLowerCase().includes(termoBusca)) ||
            (cliente.telefone && cliente.telefone.toLowerCase().includes(termoBusca))
          );
        }
        
        // Ordenar por nome
        clientesFiltrados.sort((a, b) => a.nome.localeCompare(b.nome));
        
        // Adicionar à tabela
        clientesFiltrados.forEach(cliente => {
          // Não exibir cliente "Consumidor Final" na lista
          if (cliente.id === "1" && cliente.nome === "Consumidor Final") {
            return;
          }
          
          const tr = document.createElement('tr');
          
          tr.innerHTML = `
            <td>${cliente.nome}</td>
            <td>${cliente.documento || '-'}</td>
            <td>${cliente.telefone || '-'}</td>
            <td>${cliente.cidade || '-'}</td>
            <td>
              <button class="btn btn-outline-info btn-sm btn-detalhes" data-id="${cliente.id}">
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn btn-outline-primary btn-sm btn-editar" data-id="${cliente.id}">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-outline-danger btn-sm btn-excluir" data-id="${cliente.id}">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          `;
          
          tbody.appendChild(tr);
        });
        
        // Adicionar eventos aos botões
        document.querySelectorAll('.btn-detalhes').forEach(btn => {
          btn.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            abrirDetalhesCliente(id);
          });
        });
        
        document.querySelectorAll('.btn-editar').forEach(btn => {
          btn.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            editarCliente(id);
          });
        });
        
        document.querySelectorAll('.btn-excluir').forEach(btn => {
          btn.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            excluirCliente(id);
          });
        });
      }
      
      function novoCliente() {
        // Limpar formulário
        formCliente.reset();
        clienteIdInput.value = '';
        
        // Configurar modo
        modoEdicao = false;
        formTitulo.textContent = 'Novo Cliente';
      }
      
      function editarCliente(id) {
        const cliente = db.getCliente(id);
        
        if (cliente) {
          // Preencher formulário
          clienteIdInput.value = cliente.id;
          nomeInput.value = cliente.nome;
          documentoInput.value = cliente.documento || '';
          telefoneInput.value = cliente.telefone || '';
          emailInput.value = cliente.email || '';
          enderecoInput.value = cliente.endereco || '';
          cidadeInput.value = cliente.cidade || '';
          observacoesInput.value = cliente.observacoes || '';
          
          // Configurar modo
          modoEdicao = true;
          formTitulo.textContent = 'Editar Cliente';
          
          // Scroll até o formulário em dispositivos móveis
          if (window.innerWidth < 768) {
            cardFormulario.scrollIntoView({ behavior: 'smooth' });
          }
        }
      }
      
      function excluirCliente(id) {
        const cliente = db.getCliente(id);
        
        // Não permitir excluir o cliente "Consumidor Final"
        if (cliente.id === "1" && cliente.nome === "Consumidor Final") {
          exibirMensagem('Não é possível excluir o cliente padrão', 'warning');
          return;
        }
        
        // Verificar se o cliente possui vendas
        const vendas = db.getVendas();
        const clienteTemVendas = vendas.some(venda => venda.cliente_id === id);
        
        if (clienteTemVendas) {
          exibirMensagem('Não é possível excluir cliente com vendas registradas', 'error');
          return;
        }
        
        if (cliente) {
          const confirmar = confirm(`Deseja realmente excluir o cliente "${cliente.nome}"?`);
          
          if (confirmar) {
            try {
              db.deletarCliente(id);
              carregarClientes();
              exibirMensagem('Cliente excluído com sucesso', 'success');
            } catch (erro) {
              exibirMensagem('Erro ao excluir cliente: ' + erro, 'error');
            }
          }
        }
      }
      
      function salvarCliente(e) {
        e.preventDefault();
        
        // Verificar nome
        if (!nomeInput.value.trim()) {
          exibirMensagem('O nome do cliente é obrigatório', 'error');
          return;
        }
        
        // Obter dados do formulário
        const cliente = {
          id: clienteIdInput.value,
          nome: nomeInput.value.trim(),
          documento: documentoInput.value.trim() || '',
          telefone: telefoneInput.value.trim() || '',
          email: emailInput.value.trim() || '',
          endereco: enderecoInput.value.trim() || '',
          cidade: cidadeInput.value.trim() || '',
          observacoes: observacoesInput.value.trim() || ''
        };
        
        // Adicionar data de cadastro se for novo cliente
        if (!cliente.id) {
          cliente.data_cadastro = new Date().toISOString();
        }
        
        try {
          // Salvar cliente
          db.salvarCliente(cliente);
          
          // Atualizar tabela
          carregarClientes();
          
          // Limpar formulário
          formCliente.reset();
          clienteIdInput.value = '';
          
          // Resetar modo
          modoEdicao = false;
          formTitulo.textContent = 'Novo Cliente';
          
          // Mensagem de sucesso
          exibirMensagem('Cliente salvo com sucesso', 'success');
        } catch (erro) {
          exibirMensagem('Erro ao salvar cliente: ' + erro, 'error');
        }
      }
      
      function cancelarFormulario() {
        // Limpar formulário
        formCliente.reset();
        clienteIdInput.value = '';
        
        // Resetar modo
        modoEdicao = false;
        formTitulo.textContent = 'Novo Cliente';
      }
      
      function abrirDetalhesCliente(id) {
        const cliente = db.getCliente(id);
        
        if (cliente) {
          clienteAtual = cliente;
          
          // Preencher dados do cliente
          document.getElementById('detalhe-nome').textContent = cliente.nome;
          document.getElementById('detalhe-documento').textContent = cliente.documento || '-';
          document.getElementById('detalhe-telefone').textContent = cliente.telefone || '-';
          document.getElementById('detalhe-email').textContent = cliente.email || '-';
          document.getElementById('detalhe-endereco').textContent = cliente.endereco || '-';
          document.getElementById('detalhe-cidade').textContent = cliente.cidade || '-';
          document.getElementById('detalhe-observacoes').textContent = cliente.observacoes || '-';
          
          // Formatar data
          const data = cliente.data_cadastro ? new Date(cliente.data_cadastro) : null;
          document.getElementById('detalhe-data').textContent = data ? data.toLocaleDateString('pt-BR') : '-';
          
          // Buscar últimas compras
          const vendas = db.getVendas();
          const comprasCliente = vendas.filter(venda => venda.cliente_id === cliente.id);
          
          // Ordenar por data (mais recentes primeiro)
          comprasCliente.sort((a, b) => new Date(b.data) - new Date(a.data));
          
          // Limitar a 5 últimas compras
          const ultimasCompras = comprasCliente.slice(0, 5);
          
          const divCompras = document.getElementById('ultimas-compras');
          
          if (ultimasCompras.length > 0) {
            // Criar tabela de compras
            let html = `
              <table class="table">
                <thead>
                  <tr>
                    <th>Data</th>
                    <th>ID</th>
                    <th>Pagamento</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody>
            `;
            
            ultimasCompras.forEach(venda => {
              const data = new Date(venda.data);
              const dataFormatada = data.toLocaleDateString('pt-BR');
              
              html += `
                <tr>
                  <td>${dataFormatada}</td>
                  <td>${venda.id}</td>
                  <td>${venda.forma_pagamento}</td>
                  <td>R$ ${venda.total.toFixed(2)}</td>
                </tr>
              `;
            });
            
            html += `
                </tbody>
              </table>
            `;
            
            divCompras.innerHTML = html;
          } else {
            divCompras.innerHTML = '<p class="text-center text-muted">Nenhuma compra encontrada</p>';
          }
          
          // Exibir modal
          modalDetalhes.style.display = 'flex';
        }
      }
      
      function exibirMensagem(mensagem, tipo) {
        // Criar toast
        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${tipo}`;
        toast.innerHTML = `
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-${tipo === 'success' ? 'check-circle' : tipo === 'warning' ? 'exclamation-circle' : 'times-circle'}"></i>
            <span>${mensagem}</span>
          </div>
        `;
        
        // Adicionar ao DOM
        document.body.appendChild(toast);
        
        // Exibir com animação
        setTimeout(() => {
          toast.classList.add('show');
        }, 10);
        
        // Remover após 3 segundos
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => {
            document.body.removeChild(toast);
          }, 300);
        }, 3000);
      }
    });
  </script>
  <script src="assets/js/core.js"></script>
</body>
</html>
